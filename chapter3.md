（交流可以用英文，所有文档中文，保留这句）

# 第3章 语言模态

> **开篇段落（学习目标）**
> 本章讨论语言模态在 V‑L‑A（视觉‑语言‑行动）系统中的角色：**符号推理与过程编排**。我们系统化梳理 Chain‑of‑Thought（CoT）与结构化推理、**记忆与检索**（短期/长期/外部知识库）、**工具与环境调用**（程序、API、规划器、数据库）、以及**思考预算与推理深度的自适应调度**（“少想快做” vs “深想再做”）。你将获得三类产出：
>
> 1. 面向工程的“**语言=调度器**”设计范式；
> 2. 可度量的推理—检索—调用闭环目标函数与接口；
> 3. 面向部署的**幻觉抑制、审计与可解释**实践清单。
>    **目标**：能把语言模态作为**可验证的控制平面**，桥接感知与行动，服务 Sim‑to‑Real 的**安全与可追溯**。

---

## 3.1 语言的“智性”地位：符号操作与抽象表达

语模型（LM）不仅是文本生成器，更是**任务分解器**与**资源调度器**。在 VLA 中，语言层的职责是：

* 将感知摘要与任务目标**离散化为可执行选项**（subgoals / tools / controllers）。
* 维护**可解释的过程痕迹**，为审计与回放提供证据。
* 在**有限预算**下选择**推理深度**与**外部工具**，达成风险—性能折中。

从信息论视角，可把语言层目标写成“**效用—成本**”形式：
$$
\max_{\pi_\theta,,g_\phi}\ \mathbb{E}\big[ U(y,\hat{y}) \big]
\ -\ \lambda_{\text{tok}},\mathbb{E}\big[ C_{\text{tokens}} \big]
\ -\ \lambda_{\text{tool}},\mathbb{E}\big[ C_{\text{tools}} \big],
$$
其中 $$\pi_\theta$$ 为语言策略，(g_\phi) 为**调度门控**（决定是否继续推理/是否调用工具），(U) 度量任务成功/安全/成本，(\lambda_{\cdot}) 为预算权重。

**ASCII：语言作为控制平面**

```
[视觉摘要] → [语言调度器 πθ]
                 │
                 ├─(决定续推理?)→[临时推理缓冲 τ]
                 │
                 ├─(调用工具?)→[外部API/规划器/DB]→[观测 o]
                 │
                 └─(提交执行?)→[行动层/控制层]
```

**Rule‑of‑thumb 3.1**：把语言层当作“**面向安全的调度器**”，而非“万能回答器”。任何高风险决策前，**优先调用可验证的工具**（规划器、约束求解器、数据库），语言仅做编排与解释。

---

## 3.2 Chain‑of‑Thought：分步推理与错误驱散

**CoT 的工程角色**是把**复杂问题→可验证子问题**。但在部署中必须**控制推理长度与偏差传播**。

* **结构化 CoT**：把自由文本 CoT 规整为**模式化槽位**（假设→证据→检验→结论），便于审计。
* **验证闭环**：在关键结论前加入**“检验子句”**，调用外部证据或单元检查。

将结构化推理视为有成本的中间轨迹 (\tau)：
$$
\min_{\theta}\ \mathbb{E}\big[ \ell\big(y, f_\theta(x,\tau)\big) \big] +
\lambda,\mathbb{E}\big[ C(\tau) \big],\quad
\tau \sim q_\theta(\cdot\mid x),
$$
其中 (C(\tau)) 与 token 长度、工具调用次数、延迟等相关。**目标**是在**固定预算**内最小化风险。

**ASCII：结构化 CoT 槽位**

```
[Plan]
 1) 子目标分解: g1, g2, ...
 2) 证据需求: 视觉/检索/传感器
 3) 验证点: assert-1, assert-2
 4) 执行意图: 调度(tool-A), 限时(t≤100ms)
 5) 审计摘要: 关键假设与覆盖范围
```

**Rule‑of‑thumb 3.2**：**少即是多**。面向在线系统，把 CoT 控制在**3–7 步**；超过阈值转入“**工具+检验**”分支，而非继续喋喋不休。

---

## 3.3 记忆与抽象：压缩、检索、情境绑定与会话一致性

语言层需要三类记忆：

1. **短期（上下文窗口）**：对话与当前感知摘要，随输入漂移。
2. **长期/语义记忆（知识库）**：稳定事实、策略模板、规章制度。
3. **情境记忆（任务/场景特定）**：场景地图、对手画像、危险名录。

**检索—推理联合优化**可写为：

$$
\max_{\theta,\psi}\ \mathbb{E}*{x}\Big[ U\big(y, \pi*\theta(x, \mathcal{R}*\psi(x))\big) \Big]
\ -\ \lambda,\mathbb{E}\big[ C\big(\mathcal{R}*\psi(x)\big) \big],
$$

其中 (\mathcal{R}_\psi) 为检索器（dense/lexical/混合），在**效用—检索成本**之间折中。

**混合检索打分**（实践常用）：
$$
S(q,d) = \alpha, S_{\text{lex}}(q,d) + (1-\alpha), S_{\text{dense}}(q,d),
\quad \alpha \in [0,1].
$$

**记忆金字塔（ASCII）**

```
               ┌───────────────┐  稳定知识/策略模板
               │  语义长期库   │  (KB/向量检索/规章)
               └──────┬────────┘
                      │  索引/召回 (k, α)
              ┌───────▼────────┐
              │  情境缓存/会话  │  (近期观测/对手画像)
              └───────┬────────┘
                      │  片段选择/摘要
               ┌──────▼───────┐
               │  短期上下文  │  (提示窗/KV缓存)
               └──────────────┘
```

**Rule‑of‑thumb 3.3**：**检索前先“问题澄清化”**（Query Reformulation）。把模糊的自然语言转成**结构化检索意图**（实体、时空、约束），再混合检索。**Top‑k 不求大**：多数任务 (k\in[3,8]) 足够，超大 (k) 容易引入噪声与延迟。

---

## 3.4 工具调用：代码执行、API、知识库/记忆接口

语言层通过**函数调用/计划执行**将“想法”落成“可验证的产出”。在 VLA 中，常见工具包括：几何/物理求解器、路径规划器（MPC/MIQP）、数据库/知识库、规则引擎、可达性/安全屏蔽（CBF/LTL‑Shield）。

把“调用工具”建模为**选项（options）/技能（skills）**：
$$
\pi(a\mid s) =
\sum_{o \in \mathcal{O}} \pi(o\mid s), \pi(a\mid s,o),
\quad
\beta_o(s) = \text{终止概率},
$$
语言层等价于在状态 (s) 上选择**高层选项 (o)**（如“调用 A* 规划器 50ms”），并在终止条件触发后返回。

**调用成本—风险目标**：
$$
\min\ \mathbb{E}\big[\ell(y,\hat{y})\big] +
\lambda_{\text{lat}},\mathbb{E}[T_{\text{lat}}] +
\lambda_{\text{risk}},\mathbb{E}[\text{UnverifiedStep}],
$$
优先调用**可验证/可审计**的工具，降低“不可证步骤”的占比。

**ASCII：工具调用闭环**

```
[语言意图] → (意图解析/参数化)
        → [工具执行器] →(结果/置信度/代价)→ [验证/断言]
        → (通过?) ─Yes→ [行动编排] → 控制层
                    └No → [回退计划/人类确认/降级]
```

**Rule‑of‑thumb 3.4**：**把每个工具输出都当“可疑数据”**。务必伴随**元信息**（时间戳、置信度区间、覆盖范围、边界条件），并用**断言/约束**二次校验后再进入行动层。

### 3.4.1 思考预算与推理深度的自适应调度

为避免延迟与幻觉，使用**门控策略 (g_\phi)** 动态决定“继续思考/调用工具/立即执行”。可用**代价敏感决策**：
$$
g_\phi(s) =
\begin{cases}
\text{HALT}, & \Delta U < \lambda_{\text{next}} \
\text{THINK_MORE}, & \Delta U \ge \lambda_{\text{next}},\ T<T_{\max} \
\text{TOOL_CALL}, & \text{若可验证增益}>\text{门槛}
\end{cases}
$$
(\Delta U) 为继续推理的**边际效用预估**。

**Rule‑of‑thumb 3.4.1**：线上系统设置**双阈值**：

* **延迟阈值** (T_{\max})：超过即降级为“快但保守”的策略；
* **不确定阈值**（如熵/间隔）：高不确定→**强制工具调用或人机协同**。

---

## 3.5 VLA 编排：感知→推理→行动的桥梁

语言层的核心职责是把感知输出与行动先验**对齐为可执行计划**。推荐使用“**声明式目标 + 约束 + 验证点**”三件套。

**计划可执行性目标**（示意）：
$$
\max_{\text{plan}}\ \underbrace{P(\text{success}\mid x_{\text{vision}}, \text{plan})}*{\text{达成任务}}
-\lambda*{s},\underbrace{\text{SafetyViolation}(\text{plan})}*{\text{安全}}
-\lambda*{c},\underbrace{\text{ControlCost}(\text{plan})}_{\text{平滑/舒适}},
$$
并要求**显式接口**把计划转换为**可控轨迹/约束**（详见第 4 章）。

**ASCII：从视觉摘要到可控轨迹**

```
[视觉摘要/3D支架] → [语言计划: 目标+约束+验证点]
                  → [规划器(MPC/MIQP/CBF)]
                  → [轨迹/控制参考 + 置信区间]
                  → [执行器/屏蔽RTA]
```

**Rule‑of‑thumb 3.5**：规划与控制的“**最后一跳**”避免自然语言自由输出，改为**结构化产物**（代价函数系数、约束参数、软硬阈值），以便与第4/11章的**可验证链**对接。

---

## 3.6 安全与稳健：幻觉抑制、可解释提示与审计

**三层防护**：

1. **前馈防护（提示/检索）**：把**高风险事实**从模型内隐知识转为**显式检索**；提示中明确“不可执行/需确认”的边界。
2. **中途防护（断言/屏蔽）**：在关键转折处加入**断言/CBF/Shield**；不通过即**回退/人机协同**。
3. **后验防护（审计/回放）**：存储**过程摘要**（非全量私密 CoT，而是结构化证据与决策点），用于责任界定与回放调试。

**不确定校准**（温度/能量分数/间隔）可作为**门控信号**。
简化表示：若
$$
H(p_\theta(\cdot\mid x))>\tau_H\quad\text{或}\quad
\text{margin}(x)<\tau_M,
$$
则进入“**检索+工具**”分支，且需要**二次验证**通过才触发行动。

**Rule‑of‑thumb 3.6**：**高风险=双重来源 + 双重验证**。至少使用两条**统计独立**的证据路径（如视觉→几何、语言→数据库），且通过**不同失效模式**的校验器。

---

## 3.7 面向部署：人机协同与策略可解释

现场部署强调**互操作与责任可追溯**：

* **人机分工**：语言层把**“需人确认”**的决策点结构呈现（选项+证据+风险），人类一键选择或修改阈值。
* **运行日志**：面向审计导出**决策关键帧**（触发原因、参数、证据哈希、时间戳），而非泄露全部私密推理文本。
* **策略解释**：将执行前的语言计划压缩为**“因果链卡片”**（目标→证据→约束→断言→行动），用于回放与仲裁。

**ASCII：人机闭环**

```
[语言调度器] → [证据卡片/选项A|B|C]
           └→ [自动模式?]  是→ 执行
                         否→ [人类确认/编辑] → 执行
(全程输出: 审计摘要+哈希)
```

**Rule‑of‑thumb 3.7**：把**确认动作**放在**低频高风险**节点；**高频低风险**动作自动化，但必须有**可中断/可回退**机制与**时间上界**。

---

## 本章小结

* 语言层是 VLA 的**控制平面**：负责**任务分解、资源调度与证据汇合**。
* **CoT**在工程中应转化为**结构化推理**与**验证点**，并受**预算门控**。
* **记忆/检索**采用**混合召回 + 结构化改写**，追求**小 k 高精度**与低延迟。
* **工具调用**以**选项/技能**建模，目标函数显式惩罚**不可验证步骤**与延迟。
* **安全闭环**采用**前馈（检索）—中途（断言/屏蔽）—后验（审计）**三层。
* 面向部署，输出**结构化计划/参数**而非自由文本，服务第 4/11 章的**可验证控制链**。

**关键公式速查**

1. 效用—成本目标：
$$
   \max_{\pi_\theta,g_\phi}
   \mathbb{E}[U]-\lambda_{\text{tok}}\mathbb{E}[C_{\text{tokens}}]-\lambda_{\text{tool}}\mathbb{E}[C_{\text{tools}}].
$$

2. 结构化推理正则：
$$
   \min_\theta \mathbb{E}[\ell(y,f_\theta(x,\tau))] + \lambda,\mathbb{E}[C(\tau)].
$$

3. 检索—推理联合：
$$
   \max_{\theta,\psi} \mathbb{E}\big[U\big(y,\pi_\theta(x,\mathcal{R}*\psi(x))\big)\big]-\lambda C(\mathcal{R}*\psi).
$$

4. 混合打分：
$$
   S(q,d)=\alpha S_{\text{lex}}+(1-\alpha)S_{\text{dense}}.
$$

5. 选项策与终止：
$$
   \pi(a\mid s)=\sum_o \pi(o\mid s)\pi(a\mid s,o),\quad \beta_o(s).
$$

---

## 常见陷阱与错误（Gotchas）

1. **把语言当“真理源”而非“调度器”**

   * **症状**：自由生成指令直接驱动控制，无验证。
   * **修复**：将高风险产出改为**结构化参数**，通过规划器/屏蔽二次生成。

2. **CoT 过长导致延迟与偏差累积**

   * **症状**：在线推理超时、越想越偏。
   * **修复**：设置**边际效用门控**与**步数上限**；超限则转入**检索/工具**分支。

3. **检索喂入噪声（Top‑k 过大/改写不佳）**

   * **症状**：幻觉升级为“带证据的幻觉”。
   * **修复**：先做**问题澄清化**与实体对齐；**小 k 高质**；对冲**lexical+dense**。

4. **工具调用不可验证/无元信息**

   * **症状**：工具结果可信度未知，导致错误升级。
   * **修复**：强制输出**置信度/时间戳/覆盖声明**；未达阈值则回退或人。

5. **记忆污染与越界适配**

   * **症状**：长期库混入临时假设或隐私内容。
   * **修复**：区分**长期/情境**命名空间；设**TTL/审核**；启用**数据血缘与回滚**。

6. **不确定性未闭环触发**

   * **症状**：高熵输出仍直接执行。
   * **修复**：以**熵/间隔/能量**为门控信号，强制进入**检索+验证**路径。

7. **可解释性停留在自然语言“故事”**

   * **症状**：复盘仅有叙述，没有**可执行证据**。
   * **修复**：记录**断言通过/失败、阈值、约束、工具参数**的结构化摘要与哈希。

8. **与控制层接口松散**

   * **症状**：语言输出难以落地为轨迹/约束。
   * **修复**：采用**代价/约束槽位**与**单位/范围校验**；在第 4 章的轨迹/频域接口上对齐。

9. **人机协同位置不当**

   * **症状**：把人类塞进高频环路，导致延迟与疲劳。
   * **修复**：仅在**低频高风险**节点插入确；其他采用**可中断自动化**。

10. **审计材料过度/不足**

    * **症状**：要么泄露隐私，要么无法复盘。
    * **修复**：保存**关键决策点的结构化证据**而非全量自由文本；支持**回放与签名验证**。

---

### 本章实践清单（可直接落地）

* 以“**目标+约束+验证点**”生成**结构化计划**，避免口语化控制。
* 部署**双阈值门控**：延迟上界 (T_{\max}) 与不确定阈值（熵/间隔）。
* 检索采用**混合打分**与**问题澄清化**；将 Top‑k 收敛到 3–8。
* 每个工具输出附带：**置信度、时间戳、覆盖、边界条件**。
* 审计导出**因果链卡片**（目标→证据→约束→断言→行动）+ 哈希。
* 将“不可验证步骤”比例纳入 KPI，与安全/延迟一起考核。

---

**与后续章节的接口**

* 第 4 章：把语言计划映射为**频域/时域**控制参数与**安全屏蔽**接口。
* 第 5 章：将语言—行动对齐转化为**令到轨迹**的短序列建模与蒸馏。
* 第 8–11 章：把**预算门控、不确定触发与审计**迁移到 RL、仿真与 Sim‑to‑Real 的**运行规程**中。

