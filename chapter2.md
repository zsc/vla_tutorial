（交流可以用英文，所有文档中文，保留这句）

# 第2章 视觉模态（chapter2.md）

> **开篇段落｜学习目标**
> 本章从**表征—对齐—时空**三条轴线系统梳理视觉模态。我们回顾 CNN 与金字塔等经典结构，连接到视觉—语言对齐（如对比学习/CLIP 思路）与视频自/半监督（重建、掩码、下一帧预测）。在工程侧，聚焦两类“**落地痛点**”：①**开集识别与不确定性估计**（温度缩放/能量分数/校准指标）；②**时域错位鲁棒性**（相机—IMU—控制回路的时间对齐）。
> **学习完成后，你应能：**（a）说明视觉特征的**多尺度**与**部件—整体**结构；（b）推导并实现对比学习的**InfoNCE**与温度控制原则；（c）为视频自监督设计**时域**掩码与预测任务；（d）在部署前以**ECE/NLL/能量阈值**完成开集与校准体检；（e）提出**时延补偿**与**对齐诊断**方案，并明白其对控制闭环的影响。

---

## 小节目录

* 2.1 经典视觉回顾：CNN 分层特征与“部件—整体”分解
* 2.2 Marr 式表征思想与多尺度处理
* 2.3 视觉—语言对齐：对比学习与 CLIP 思路

  * 2.3.1 对齐特征 vs. 纯视觉特征：全局语义与细节取舍
  * 2.3.2 图文数据瓶颈：描述稀疏与自动标注的细节缺失
* 2.4 视频自/半监督：重建、掩码、下一帧/片段预测

  * 2.4.1 时间建模：持续性、运动线索与长期依赖
* 2.5 视觉难点与开放问题：符号化/抽象与泛化

  * 2.5.1 开集识别与不确定性估计（温度缩放、能量分数）
  * 2.5.2 时域错位鲁棒性：对齐、漂移与补偿
* 2.6 路线组合：混合训练与阶段化设计
* 2.7 小结：为对齐、行动与迁移奠基

---

## 2.1 经典视觉回顾：CNN 分层特征与“部件—整体”分解

**分层与等变/不变性**
卷积与池化形成从**局部边缘/纹理**到**部件**再到**全局形状**的层级。低层保持**平移等变**，高层倾向**类别不变**。
**有效感受野**（effective receptive field, ERF）定量刻画“一个输出像素能看到多大输入区域”：
[
\begin{aligned}
R_0 &= 1,\quad S_0 = 1 \
R_\ell &= R_{\ell-1} + (k_\ell-1),d_\ell,\prod_{j=0}^{\ell-1} s_j, \
S_\ell &= S_{\ell-1}\cdot s_\ell,
\end{aligned}
]
其中 (k_\ell) 为核大小、(s_\ell) 步幅、(d_\ell) 膨胀率。**Rule‑of‑thumb**：在检测/操控中，目标最小尺寸 (\approx) 最早能覆盖它的层的 (R_\ell)；若 (R_\ell) 过小，会出现**局部语义碎片化**。

**多尺度金字塔（FPN/Laplacian）**
自顶向下与横向连接让浅层的细节与高层的语义融合：

```
输入图像
   │
[Conv stages]───┐
   │             ├───> P3 (细节多)
   └─────────────┤
                 ├───> P4
                 └───> P5 (语义强)
```

**工程提示**：在 VLA 中，**动作相关像素**（接触面、边界、车道线）通常出现在**中高频通道**；在融合时保留至少一条**高分辨率支路**以避免“语义好但几何糊”。

---

## 2.2 Marr 式表征思想与多尺度处理

**Marr 三层次**：计算理论（要素/目标）、表示与算法、实现。视觉表征常对应：**原始素描**（边缘/角点）、**2.5D 草图**（表面朝向/深度）、**3D 结构**（可用于操控/预测）。

**尺度空间理论**
用高斯核生成尺度空间：
[
L(\mathbf{x},\sigma) = (G_\sigma * I)(\mathbf{x}),\quad
G_\sigma(\mathbf{x}) = \frac{1}{2\pi\sigma^2}\exp!\left(-\frac{|\mathbf{x}|^2}{2\sigma^2}\right).
]
LoG/DoG 在不同 (\sigma) 上找极值，稳定关键点。**Rule‑of‑thumb**：选择 (\sigma) 使得核直径 (\approx) 目标最小宽度的 (1!~\text{to}~!2) 倍，可在噪声鲁棒与细节保真间折中。

---

## 2.3 视觉—语言对齐：对比学习与 CLIP 思路

**双塔对齐与 InfoNCE**
图像塔 (f_\theta(x)) 与文本塔 (g_\phi(t)) 被拉到同一嵌入空间，使用温度化的余弦相似度 (s_{ij}=\frac{f_i^\top g_j}{|f_i||g_j|})。对称 InfoNCE：
[
\mathcal{L}*{\text{img}\to\text{text}}
= -\frac{1}{N}\sum*{i=1}^N
\log
\frac{\exp(s_{ii}/\tau)}{\sum_{j=1}^N \exp(s_{ij}/\tau)},\quad
\mathcal{L}*{\text{text}\to\text{img}}\ \text{同理},
]
[
\mathcal{L}=\tfrac{1}{2}!\left(\mathcal{L}*{\text{img}\to\text{text}}+\mathcal{L}_{\text{text}\to\text{img}}\right).
]
**温度 (\tau)** 控制**软负样本挤压**力度；(\tau) 过小→优化难且过分“尖锐”；过大→对齐松散。
**Rule‑of‑thumb**：在 batch‑size (B) 固定时，(\tau) 调到**验证检索**的 mAP 或 Recall@K 最优，而非训练 loss 最小。

### 2.3.1 对齐特征 vs. 纯视觉特征：全局语义与细节取舍

* **对齐特征**（CLIP 类）擅长**全局语义与检索**，但可能**丢细节**（边界、几何精度）。
* **纯视觉特征**（自监督/监督）几何更稳，但语义弱。
  **工程折中**：
* 检测/操控：优先**纯视觉 backbone + 语言门控**（cross‑attn 只调度）。
* 检索/描述：优先**对齐特征**，必要时加**高频残差支路**修补几何。

### 2.3.2 图文数据瓶颈：描述稀疏与自动标注的细节缺失

* **弱描述性 Alt‑Text**：文本常不含**空间关系/数量词/材质**。
* **自动标注噪声**：生成式字幕会**幻觉细节**。
  **Rule‑of‑thumb**：

1. **难例挖掘**：强化“空间词+数量词”（如“左/右/三颗螺丝”）配对的采样权重；
2. **一致性对比**：对几何扰动（裁剪/旋转）后的同图，文本不变→拉近图—图、图—文；
3. **负例净化**：过滤“近重复”负样本，避免过强的假负例。

---

## 2.4 视频自/半监督：重建、掩码、下一帧/片段预测

**三类任务**

1. **重建/掩码（MAE‑V）**：时间/空间 token 掩掉 (p%)，预测像素/特征。
2. **下一帧/片段预测**：最小化 (\ell_1/\ell_2) 或感知损失 (\mathcal{L}_{\text{percep}})，也可在频域加入带宽正则（抑过度锐化/振铃）。
3. **时序顺序/对比**：打乱片段顺序、预测是否“时间可达”。
   [
   \mathcal{L}*{\text{video}}=\lambda*{\text{rec}}\mathcal{L}*{\text{rec}}
   +\lambda*{\text{pred}}\mathcal{L}*{\text{pred}}
   +\lambda*{\text{cont}}\mathcal{L}_{\text{cont}}.
   ]

**频域视角（与行动对接）**
对视频/光流进行**带通限制**，与行动侧的**加速度/跃度约束**一致。**Rule‑of‑thumb**：对操控任务的视觉分支，限制到**不超过控制回路 1/2 带宽**的时域变化，降噪且减少相位滞后感知误报。

### 2.4.1 时间建模：持续性、运动线索与长期依赖

* **短期**：1D 时域卷积/门控单元（TCN/GRU）。
* **长期**：稀疏注意力/分块记忆（固定内存窗口 (W) + 检索关键帧）。
* **运动先验**：显式光流 (\mathbf{u}=(u,v)) 与稳定点约束：
  [
  I(x,y,t) \approx I(x+u,\Delta t, y+v,\Delta t, t+\Delta t).
  ]
  **工程提示**：对具有**慢变背景+快速前景**的场景，采用**双路径**（慢路径聚合语义，快路径保留细节）可稳住小目标。

---

## 2.5 视觉难点与开放问题：符号化/抽象与泛化

**“压缩”≠“抽象”**
最小化重建误差的压缩不一定学到任务所需的**可操作语义**。

* **率失真**：(\min_{q} \ \mathbb{E}[d(X,\hat X)] + \beta,I(X;Z))
* **信息瓶颈**：(\min_{q} \ I(X;Z) - \beta, I(Z;Y))
  抽象需要最大化 (I(Z;Y))，而非仅减小 (I(X;Z))。
  **工程要点**：在 VLA 中，令 (Y) 包含**行动相关标量**（可达性、接触状态），有助于学到**可控语义**。

### 2.5.1 开集识别与不确定性估计（温度缩放、能量分数）

**温度缩放（后校准）**
对 logits (z_k) 进行温度化：
[
p_k = \frac{\exp(z_k/T)}{\sum_j \exp(z_j/T)}.
]
仅调 (T)（在验证集上最小化 NLL）可显著改善**置信度校准**。

**能量分数（Energy Score）用于 OOD**
[
E(x) = -T \log \sum_{k} \exp(z_k(x)/T).
]
以阈值 (\gamma) 判定开集：(E(x)>\gamma\Rightarrow \text{OOD})。
**校准指标**

* **ECE**：(\text{ECE}=\sum_{m=1}^M \frac{|B_m|}{n},|\text{acc}(B_m)-\text{conf}(B_m)|)。
* **Brier 分数**：(\text{BS}=\tfrac{1}{n}\sum_i\sum_k (p_{ik}-y_{ik})^2)。
  **Rule‑of‑thumb**：部署前做三步——(1) 温度缩放（NLL/ECE 选优）；(2) 设定能量阈值满足**FPR@95%TPR**≤目标；(3) 触发**Safeguard**（降级/二次感知）。

> **调参与落地**
>
> * 多头任务：对每个头**独立**温度缩放，避免跨任务校准干扰。
> * 轻量不确定性：优先**深度集成（2–4 个子模型）**或**MC Dropout（推理开关）**；对资源敏感系统，使用**Dirichlet 先验网络**近似。

### 2.5.2 时域错位鲁棒性：对齐、漂移与补偿

**问题定义**：传感器时间戳/传输延迟/编码缓存导致视觉帧相对控制时基**偏移 (\Delta t)** 或**抖动**。

* **交叉相关估计偏移**：
  [
  \hat{\Delta t}=\arg\max_{\tau}\ \text{NCC}!\left(x(t), y(t+\tau)\right),
  ]
  中 (x) 可取 IMU/轮速事件流，(y) 为从视频导出的运动量（如光流模）。
* **滞后建模**：控制侧零阶保持 + 纯时延 (e^{-s\Delta t}) 的相位损失 (\phi(\omega)=-\omega\Delta t)。
  **Rule‑of‑thumb**：把视觉到控制的**总时延**控制在**控制周期 (T_c) 的 10–20%** 内；超出则应**预测外推**（基于运动模型）并在策略上**增加相位裕度**（第4章/第11章细化）。

**工程工具箱**

* **时间戳统一**：统一到**单调时钟**，拒绝相机自带的可回绕时间。
* **帧—IMU 对齐**：卡尔曼“时间滤波器”（把 (\Delta t) 作为状态估计）。
* **数据增强**：训练时注入 (\Delta t\sim\mathcal{U}[-\delta,\delta]) 的“**时延抖动**”。

---

## 2.6 路线组合：混合训练与阶段化设计

**分阶段**：
(1) **模态内**：视觉自监督（掩码/对比）稳定几何与低级统计；
(2) **跨模态对齐**：以 InfoNCE/对齐检索指标为主；
(3) **任务化/指令化**：引入**行动相关标签**与语言锚点。

**多目标加权**
[
\mathcal{L}=\sum_i \lambda_i \mathcal{L}_i,\quad
\lambda_i \propto \frac{1}{\sigma_i^2}\ \ (\text{不确定性加权}),
]
并辅以**梯度外科**（如投影/冲突解耦）避免任务互相拉扯。
**采样日程**：从“几何重建/掩码为主”缓退到“对齐/任务为主”；**Rule‑of‑thumb**：保持**几何类样本≥30%** 直到下游几何 KPI（深度/边界 IoU）稳定。

---

## 2.7 小结：为对齐、行动与迁移奠基

**关键概念与公式回顾**

* **ERF**：决定最早可分辨尺度；(R_\ell = R_{\ell-1}+(k_\ell-1)d_\ell\prod s)。
* **尺度空间**：(L(\mathbf{x},\sigma)=G_\sigma*I)，LoG/DoG 稳关键点。
* **对比学习（InfoNCE）**：双塔温度化相似度，(\tau) 决定软负样本力度。
* **视频自监督损失组合**：重建/预测/对比的加权。
* **抽象 vs 压缩**：信息瓶颈强调 (I(Z;Y)) 才是可操作语义。
* **不确定性与开集**：温度缩放 + 能量分数 (E(x)=-T\log\sum\exp(z/T))；ECE/Brier 评估校准。
* **时域错位**：交叉相关估计 (\Delta t)；总时延 (\lesssim 0.1!~\text{to}~!0.2,T_c)。

> **Rule‑of‑thumb（速记版）**
>
> 1. **多尺度恒存**：至少保留一条高分辨率支路给几何；
> 2. **(\tau) 用验证检索调**，而非训练 loss；
> 3. **部署前三件套**：温度缩放→能量阈值→Safeguard；
> 4. **视频频域限带**：不超过控制回路半带宽；
> 5. **时间对齐优先级高于模型精度**：先消时延再谈更深模型。

---

## 常见陷阱与错误（Gotchas）与调试技巧

1. **把对齐特征直接拿去做几何密集任务**

   * *症状*：边界糊、接触定位漂移。
   * *排查*：查看高频误差谱；对齐前后比较边界 IoU。
   * *修复*：加入**几何分支**或高频残差，融合时给几何更高权重。

2. **忽视开集/校准导致过度自信**

   * *症状*：置信度高但策略频繁失败；RTA 触发迟。
   * *排查*：绘制**可靠性图**与 ECE，统计 **FPR@95%TPR**（ID vs OOD）。
   * *修复*：温度缩放 + 能量阈值；必要时引入**拒识**通道与人机协同。

3. **时域错位被当成分布移位**

   * *症状*：仿真 OK、实车抖动/延迟；视频看起来“对”，控制却晚。
   * *排查*：IMU/轮速 vs 光流的交叉相关；事件相机/里程计对齐。
   * *修复*：统一单调时钟；估计并补偿 (\hat{\Delta t})；训练时注入**时延增强**。

4. **过宽频内容导致控制振荡**

   * *症状*：策略在高频纹理/闪烁光下过度反应。
   * *排查*：视觉特征功率谱；与控制输出的互谱相干。
   * *修复*：视频分支限带；在损失加**平滑/带宽正则**；行动侧增加**相位裕度**。

5. **图文负例污染（近重复/同场景）**

   * *症状*：InfoNCE 训练看似收敛，检索却崩。
   * *排查*：可视化“最难负例”；计算图—图相似度分布偏斜。
   * *修复*：**重复过滤**、类别均衡采样；对语义近邻引入**较软权重**而非硬负。

6. **只看平均，不看长尾**

   * *症状*：总体 mAP 高，关键场景（夜间、雨雾）失败。
   * *排查*：建立**情境切片**报告（天气/时段/场景复杂度）。
   * *修复*：**课程化随机化**与**难例过采样**；对 OOD 情境单独设阈与降级策略。

7. **抽象等同压缩的误解**

   * *症状*：重建指标优而任务失败。
   * *排查*：衡量 (I(Z;Y)) 的代理（任务损失、可达性预测 AUC）。
   * *修复*：加入**任务条件**或**行动标签**，用**蒸馏**把特权信息迁入可部署表征。

8. **忽略镜头/滚快门与曝光动态**

   * *症状*：快速运动/LED 闪烁下，边界拉伸与时间畸变。
   * *排查*：滚快门方向与速度估计；曝光曲线统计。
   * *修复*：**滚快门仿真**加入域随机化；用**事件/IMU**辅助矫正。

---

> **本章与全书主线的接口**
> 视觉表征是“更大更深”即可，它必须在**三件套**（对齐可控、时域一致、可校准）下服务**行动**。接下来第3–5章将把这些表征与**语言/行动**对齐，8–11章在**RL 与 Sim‑to‑Real**中验证其可迁移与安全性。

